<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Keith McNulty">

<title>15&nbsp; Causal Inference - Moving From Association to Causation – Handbook of Regression Modeling in People Analytics (2nd edition)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./further.html" rel="next">
<link href="./other_bayesian_regression.html" rel="prev">
<link href="./www/cover/coverpage-og.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-809cd4ad8465a863d451ae2f0a07b33b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./causal_inference.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causal Inference - Moving From Association to Causation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Handbook of Regression Modeling in People Analytics (2nd edition)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/keithmcnulty/regression-handbook-2nd-edition" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./foreword.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foreword by Alexis Fink</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./importance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Importance of Regression in People Analytics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basic_r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Basics of the R Programming Language</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./primer_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Statistics Foundations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Linear Regression for Continuous Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./binomial_logistic_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Binomial Logistic Regression for Binary Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multinomial_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Multinomial Logistic Regression for Nominal Category Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ordinal_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Proportional Odds Logistic Regression for Ordered Category Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./poisson_nb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Poisson, Quasi-Poisson and Negative Binomial Regression for Count Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modeling Explicit and Latent Hierarchy in Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./survival_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Survival Analysis for Modeling Singular Events Over Time</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power_tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Power Analysis for Estimating Required Sample Sizes for Modeling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayesian_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Bayesian Inference - A Modern Alternative to Classical Statistical Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayesian_linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Linear Regression Using Bayesian Inference</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other_bayesian_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Fitting Other Regression Models Using Bayesian Inference</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal_inference.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causal Inference - Moving From Association to Causation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./further.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Further Exercises for Practice</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bibliography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#underlying-theoretical-frameworks-for-causal-inference" id="toc-underlying-theoretical-frameworks-for-causal-inference" class="nav-link active" data-scroll-target="#underlying-theoretical-frameworks-for-causal-inference"><span class="header-section-number">15.1</span> Underlying theoretical frameworks for causal inference</a></li>
  <li><a href="#the-rubin-causal-model-rcm" id="toc-the-rubin-causal-model-rcm" class="nav-link" data-scroll-target="#the-rubin-causal-model-rcm"><span class="header-section-number">15.2</span> The Rubin causal model (RCM)</a>
  <ul class="collapse">
  <li><a href="#treatment-effects" id="toc-treatment-effects" class="nav-link" data-scroll-target="#treatment-effects"><span class="header-section-number">15.2.1</span> Treatment effects</a></li>
  <li><a href="#naive-comparisons-and-counfounding" id="toc-naive-comparisons-and-counfounding" class="nav-link" data-scroll-target="#naive-comparisons-and-counfounding"><span class="header-section-number">15.2.2</span> Naive comparisons and counfounding</a></li>
  <li><a href="#causal-inference-from-observational-data" id="toc-causal-inference-from-observational-data" class="nav-link" data-scroll-target="#causal-inference-from-observational-data"><span class="header-section-number">15.2.3</span> Causal inference from observational data</a></li>
  <li><a href="#the-boobytraps-of-causal-inference" id="toc-the-boobytraps-of-causal-inference" class="nav-link" data-scroll-target="#the-boobytraps-of-causal-inference"><span class="header-section-number">15.2.4</span> The ‘boobytraps’ of causal inference</a></li>
  </ul></li>
  <li><a href="#the-structural-causal-model-scm" id="toc-the-structural-causal-model-scm" class="nav-link" data-scroll-target="#the-structural-causal-model-scm"><span class="header-section-number">15.3</span> The structural causal model (SCM)</a>
  <ul class="collapse">
  <li><a href="#directed-acyclic-graphs-dags" id="toc-directed-acyclic-graphs-dags" class="nav-link" data-scroll-target="#directed-acyclic-graphs-dags"><span class="header-section-number">15.3.1</span> Directed Acyclic Graphs (DAGs)</a></li>
  <li><a href="#dag-paths-and-the-three-fundamental-structures" id="toc-dag-paths-and-the-three-fundamental-structures" class="nav-link" data-scroll-target="#dag-paths-and-the-three-fundamental-structures"><span class="header-section-number">15.3.2</span> DAG paths and the three fundamental structures</a></li>
  <li><a href="#sec-backdoor" id="toc-sec-backdoor" class="nav-link" data-scroll-target="#sec-backdoor"><span class="header-section-number">15.3.3</span> D-separation and the backdoor criterion</a></li>
  <li><a href="#example-of-applying-the-backdoor-criterion" id="toc-example-of-applying-the-backdoor-criterion" class="nav-link" data-scroll-target="#example-of-applying-the-backdoor-criterion"><span class="header-section-number">15.3.4</span> Example of applying the backdoor criterion</a></li>
  </ul></li>
  <li><a href="#causal-inference-in-r" id="toc-causal-inference-in-r" class="nav-link" data-scroll-target="#causal-inference-in-r"><span class="header-section-number">15.4</span> Causal inference in R</a>
  <ul class="collapse">
  <li><a href="#walkthrough-example" id="toc-walkthrough-example" class="nav-link" data-scroll-target="#walkthrough-example"><span class="header-section-number">15.4.1</span> Walkthrough example</a></li>
  <li><a href="#specifying-and-visualizing-the-dag" id="toc-specifying-and-visualizing-the-dag" class="nav-link" data-scroll-target="#specifying-and-visualizing-the-dag"><span class="header-section-number">15.4.2</span> Specifying and visualizing the DAG</a></li>
  <li><a href="#deriving-information-from-the-dag" id="toc-deriving-information-from-the-dag" class="nav-link" data-scroll-target="#deriving-information-from-the-dag"><span class="header-section-number">15.4.3</span> Deriving information from the DAG</a></li>
  <li><a href="#using-dags-to-guide-regression-analyses" id="toc-using-dags-to-guide-regression-analyses" class="nav-link" data-scroll-target="#using-dags-to-guide-regression-analyses"><span class="header-section-number">15.4.4</span> Using DAGs to guide regression analyses</a></li>
  </ul></li>
  <li><a href="#learning-exercises" id="toc-learning-exercises" class="nav-link" data-scroll-target="#learning-exercises"><span class="header-section-number">15.5</span> Learning exercises</a>
  <ul class="collapse">
  <li><a href="#discussion-questions" id="toc-discussion-questions" class="nav-link" data-scroll-target="#discussion-questions"><span class="header-section-number">15.5.1</span> Discussion questions</a></li>
  <li><a href="#data-exercises" id="toc-data-exercises" class="nav-link" data-scroll-target="#data-exercises"><span class="header-section-number">15.5.2</span> Data exercises</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/keithmcnulty/regression-handbook-2nd-edition/edit/main/causal_inference.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/keithmcnulty/regression-handbook-2nd-edition/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causal Inference - Moving From Association to Causation</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This book is about statistics, and over many previous chapters we have covered numerous classical and modern approaches to explanatory statistical modeling. Historically, statisticians have been careful to view such models as descriptive tools for summarizing associations in data, rather than as tools for making causal claims. In our previous chapters, when interpreting the output of models, our language has been very intentional in relation to this. We have used language rooted in description and association, such as ‘x has an effect on y’ or ‘a change in x is associated with a change in y’. We have deliberately avoided using phrases with action verbs like ‘a change in x <em>causes</em> a change in y’ or ‘a change in x <em>drives</em> a change in y’. This caution reflects a long-standing principle in statistics, and one which has become a very popular refrain over the years: association (or correlation) does not imply causation.</p>
<p>In reality, however, most of us who practice statistics do not employ our toolkit and skillset to simply describe associations. We want to understand the dynamic mechanisms of the problem we are interested in, and often that means we want to understand whether causal relationships exist. For example, we may want to know if a new employee benefit has caused an increase in employee satisfaction, or if a change in the structure of an education program has caused better learning outcomes. Moreover, when our leaders and clients want us to help them make decisions, they often have questions like <em>‘Why is this happening?’</em> or <em>‘What would happen if…?’</em>. Answering questions like these requires inferring causality. Realistically, if an analyst is simply not willing to have an opinion on questions of causality, their skills may be of limited value to decision-makers.</p>
<p>But inferring causality is hard and requires a lot of intellectual discipline. In the modeling examples and exercises in previous chapters of this book, we did not have this discipline in mind. Our focus was on the theory, execution and direct interpretation of statistical methods. In our quest for associations, we threw many variables into models without much thought about the role each variable might play in the causal mechanics of the problem we were trying to solve. As we will learn in this chapter, this is not a good practice when our goal is to infer causality. Causal inference requires careful thinking about the data generating process, the role of confounding variables, and the assumptions we are making when we use statistical models to find evidence to support or disregard a causal hypothesis.</p>
<p>Over the last few decades there has been a growing body of work in statistics, psychology, clinical medicine and related fields that has developed rigorous frameworks and methods for causal inference. This chapter introduces some of these key concepts and methods with a focus on how they can be applied in practice. We will spend the first part of the chapter introducing the fundamental theories underlying causal inference, and then we will look at the toolkit of methods that can be used to infer causality from data. Finally, we will use a walkthrough example to illustrate how this toolkit can be applied in practice.</p>
<section id="underlying-theoretical-frameworks-for-causal-inference" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="underlying-theoretical-frameworks-for-causal-inference"><span class="header-section-number">15.1</span> Underlying theoretical frameworks for causal inference</h2>
<p>The modern field of causal inference has been primarily shaped by two complementary frameworks. Throughout this chapter, we will draw on the strengths of both.</p>
<ol type="1">
<li><p><strong>The Rubin causal model (or Potential Outcomes framework):</strong> Popularized by Donald Rubin (<span class="citation" data-cites="rubin1974">Rubin (<a href="bibliography.html#ref-rubin1974" role="doc-biblioref">1974</a>)</span>), this model is rooted in the language of experiments. It forces us to think about the “potential” state of the world under different scenarios. For each individual, we imagine two potential outcomes: the outcome if they receive a “treatment” (e.g., attending a training program) and the outcome if they receive the “control” (e.g., not attending). The causal effect is the difference between these two potential outcomes. The core difficulty, which we will explore, is that we can only ever observe <em>one</em> of these outcomes for any given individual. This is what is called the <em>“Fundamental Problem of Causal Inference”</em> (<span class="citation" data-cites="holland1986">Holland (<a href="bibliography.html#ref-holland1986" role="doc-biblioref">1986</a>)</span>). This framework is incredibly useful for defining what a causal effect <em>is</em> with mathematical precision.</p></li>
<li><p><strong>The structural causal model (SCM):</strong> Championed by Judea Pearl (<span class="citation" data-cites="pearl2000">Pearl (<a href="bibliography.html#ref-pearl2000" role="doc-biblioref">2000</a>)</span>), this framework uses the intuitive language of graphs to represent our causal assumptions and hypotheses. Through using <em>Directed Acyclic Graphs (DAGs)</em>, we can visualize the assumed data-generating process. By drawing nodes (variables) and arrows (causal effects), we create a causal map of the system we are studying. This map then provides us with a clear, visual guide for how to analyze our data. It tells us which variables we must control for, which we must <em>not</em> control for, and whether our causal question is even answerable with the data we have.</p></li>
</ol>
<p>While historically there has been some friction between these two philosophies, they are now largely seen as two sides of the same coin. The RCM provides the rigorous definition of a causal effect, while the SCM give us the tools to think about the complex system of variables in which that effect is embedded. In this chapter, we will use the RCM to understand <em>what</em> we’re trying to estimate and we will use the SCM to figure out <em>how</em> to estimate it from data. For a more in-depth treatment of the Rubin causal model, see <span class="citation" data-cites="imbens2015">Imbens and Rubin (<a href="bibliography.html#ref-imbens2015" role="doc-biblioref">2015</a>)</span>. For a more in-depth treatment of the Structural causal model, see <span class="citation" data-cites="pearl2016">Pearl, Glymour, and Jewell (<a href="bibliography.html#ref-pearl2016" role="doc-biblioref">2016</a>)</span> or <span class="citation" data-cites="pearl2019">Pearl and Mackenzie (<a href="bibliography.html#ref-pearl2019" role="doc-biblioref">2019</a>)</span>. <span class="citation" data-cites="brumback2022">Brumback (<a href="bibliography.html#ref-brumback2022" role="doc-biblioref">2022</a>)</span> and <span class="citation" data-cites="mcelreath">McElreath (<a href="bibliography.html#ref-mcelreath" role="doc-biblioref">2020</a>)</span> are also excellent resources for learning about how to apply causal inference techniques in settings involving observational data.</p>
</section>
<section id="the-rubin-causal-model-rcm" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="the-rubin-causal-model-rcm"><span class="header-section-number">15.2</span> The Rubin causal model (RCM)</h2>
<p>Throughout this book we have looked at statistical effects, but we have only defined these in the context of associations between variables. For example, in a linear regression model, we use coefficients to describe the effect of a one unit change in an input variable on the outcome variable, assuming no change in the other input variables. A natural question that arises from this is ‘how much, if any, of this effect is causal?’. For this, we need a definition of what we mean by a “causal effect.” The most intuitive and mathematically rigorous way to think about this is through the Rubin causal model (RCM).</p>
<section id="treatment-effects" class="level3" data-number="15.2.1">
<h3 data-number="15.2.1" class="anchored" data-anchor-id="treatment-effects"><span class="header-section-number">15.2.1</span> Treatment effects</h3>
<p>Imagine a single manager of a sales team in a company, let’s call her Jane. Jane has the option to volunteer for a new management training program. We are interested in the causal effect of this new program on the sales of Jane’s team. Let’s denote the treatment, which is participation in the training program, as <span class="math inline">\(T\)</span>. Jane can either receive the treatment (<span class="math inline">\(T = 1\)</span>) or not receive it (<span class="math inline">\(T = 0\)</span>).</p>
<p>Under RCM, we imagine that for Jane, there exist two potential outcomes right before her decision is made about her attendance at the training:</p>
<ul>
<li><span class="math inline">\(Y(1)\)</span>: This is Jane’s team’s sales if she were to attend the training program.</li>
<li><span class="math inline">\(Y(0)\)</span>: This is Jane’s team’s sales if she were not to attend the training program.</li>
</ul>
<p>The <em>individual treatment effect (ITE)</em> for Jane is simply the difference between these two potential outcomes—that is:</p>
<p><span class="math display">\[
\mathrm{ITE} = Y(1) - Y(0)
\]</span></p>
<p>If Jane’s team’s sales figure would be $2.1 million if she were to attend the training (<span class="math inline">\(Y(1) = 2.1\)</span>) and if it would be $1.6 million if she were not to attend (<span class="math inline">\(Y(0) = 1.6\)</span>), then the ITE of the training for Jane is $0.5 million. Her attendance at the training caused a $500,000 increase in her team’s sales.</p>
<p>But in the real world, we can never observe both potential outcomes for the same individual at the same time. Jane will either attend the training or she will not.</p>
<ul>
<li>If she attends the training (<span class="math inline">\(T = 1\)</span>), we observe <span class="math inline">\(Y(1)\)</span>. <span class="math inline">\(Y(0)\)</span> is unobserved; it is a <strong>counterfactual</strong>. We know what her team’s sales figure is now that she has attended, but we will never know what it would have been had she not attended.</li>
<li>If she does not attend the training (<span class="math inline">\(T = 0\)</span>), we observe <span class="math inline">\(Y(0)\)</span>. <span class="math inline">\(Y(1)\)</span> is unobserved; it is also a counterfactual. We know what her team’s sales figure is now that she has not attended, but we will never know what it would have been had she attended.</li>
</ul>
<p>This real life issue is called the <strong>Fundamental Problem of Causal Inference</strong>. Causal inference is, in essence, a missing data problem. For every single person in our study, at least half of the crucial information (one of their potential outcomes) is missing. The table below illustrates this. The question marks represent the unobservable, counterfactual outcomes.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Employee</th>
<th style="text-align: left;">Attended Training (T)</th>
<th style="text-align: left;">Outcome if Trained (Y(1))</th>
<th style="text-align: left;">Outcome if Not Trained (Y(0))</th>
<th style="text-align: left;">Observed Outcome (Y)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Jane</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">$2.1m</td>
<td style="text-align: left;">?</td>
<td style="text-align: left;">$2.1m</td>
</tr>
<tr class="even">
<td style="text-align: left;">David</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">?</td>
<td style="text-align: left;">$3.1m</td>
<td style="text-align: left;">$3.1m</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Suraya</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">$1.2m</td>
<td style="text-align: left;">?</td>
<td style="text-align: left;">$1.2m</td>
</tr>
<tr class="even">
<td style="text-align: left;">Zubin</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">?</td>
<td style="text-align: left;">$2.9m</td>
<td style="text-align: left;">$2.9m</td>
</tr>
</tbody>
</table>
<p>Now we know that we can never calculate the individual treatment effect for any single person. But as statisticians, we could instead aim for the next best thing. We could aim to estimate the <strong>average treatment (ATE)</strong> effect across a population of individuals. This is the mean (or expected) difference in potential outcomes if <em>everyone</em> in the population were to receive the treatment versus if <em>everyone</em> were to receive the control. Formally, it is defined as:</p>
<p><span class="math display">\[
\mathrm{ATE} = E[Y(1) - Y(0)]
\]</span></p>
<p>If we estimate the ATE of our management training to be $0.6 million, it means that, on average, the program increases average team sales by that amount. This is exactly the kind of information a decision-maker needs to evaluate the program’s worth. For example, they can compare the ATE to the cost of running the training to see if the investment has a positive financial return.</p>
<p>But, again, in real life it is usually the case that not everyone is treated. Our training program is optional it’s likely to everyone will attend. Therefore, it is more insightful for us to determine the average treatment effect for those who attend the training. We want to determine the average treatment effect for the treated, known as the ATT:</p>
<p><span class="math display">\[
\begin{aligned}
\mathrm{ATT} &amp;= E[Y(1) - Y(0) \mid T=1] \\
&amp;= E[Y(1) \mid T=1] - E[Y(0) \mid T=1]
\end{aligned}
\]</span></p>
<p>The question now becomes: how can we estimate the ATT when we can’t see Y(0) for the people who have been treated?</p>
</section>
<section id="naive-comparisons-and-counfounding" class="level3" data-number="15.2.2">
<h3 data-number="15.2.2" class="anchored" data-anchor-id="naive-comparisons-and-counfounding"><span class="header-section-number">15.2.2</span> Naive comparisons and counfounding</h3>
<p>The simplest thing we could do is use the data we have, and calculate the difference in the average observed outcomes between the two groups: treated and not treated. This is called the <strong>naive comparison (NC)</strong>.</p>
<p><span class="math display">\[
\mathrm{NC} = E[Y(1) \mid T=1] - E[Y(0) \mid T=0]
\]</span></p>
<p>Let’s examine the formal mathematical difference between the naive comparison and the ATT.</p>
<p><span class="math display">\[
\begin{aligned}
\mathrm{NC} - \mathrm{ATT} &amp;= E[Y(1) \mid T=1] - E[Y(0) \mid T=0] - \\&amp; \mathrm{\ \ \ \ \ } (E[Y(1) \mid T=1] - E[Y(0) \mid T=1]) \\
&amp;= E[Y(0) \mid T=1] - E[Y(0) \mid T=0]
\end{aligned}
\]</span></p>
<p>This is known as the <strong>bias</strong> of the naive comparison as an estimator for the ATT. If this bias is zero, then the naive comparison is an unbiased estimator of the ATT. If this bias is not zero, then the naive comparison is a biased estimator of the ATT. This bias term can be non zero for a variety of reasons, but the most common is <strong>confounding</strong><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Confounding is the presence of a third variable (or set of variables) that is a common cause of both the treatment and the outcome. This common cause creates a spurious association between the treatment and the outcome that is not causal.</p>
<p>Returning to the management training example, the managers who volunteer for training (<span class="math inline">\(T=1\)</span>) might be more ambitious, more motivated, and already better managers than those who do not (<span class="math inline">\(T=0\)</span>). Therefore, even if nobody got the training, the treatment group’s teams would likely have higher sales anyway. That is, <span class="math inline">\(E[Y(0) \mid T=1] &gt; E[Y(0) \mid T=0]\)</span>. This difference is confounding. The ambition and motivation of the managers is a common cause of both their decision to take the training and their team’s higher sales.</p>
<p>The naive comparison mixes the true causal effect of the training (ATT) with this pre-existing bias. Our entire goal in causal inference is to find a way to eliminate this bias and isolate the true ATT. The most effective (but, sadly, usually the least practical) way to do this is through a randomized controlled trial (RCT).</p>
<p>In an RCT, the researchers randomly assign individuals to either the treatment or the control group. Because the assignment is random, it cannot be correlated with any pre-existing characteristics of the individuals. Over large numbers, randomization ensures that, on average, the treatment group and the control group are identical in every way <em>before</em> the treatment is administered. Under these conditions, the bias term is zero and the naive comparison is equal to the ATT.</p>
</section>
<section id="causal-inference-from-observational-data" class="level3" data-number="15.2.3">
<h3 data-number="15.2.3" class="anchored" data-anchor-id="causal-inference-from-observational-data"><span class="header-section-number">15.2.3</span> Causal inference from observational data</h3>
<p>Unfortunately, in psychology, sociology, human resources and other people-related fields we can’t always run an RCT. It might be inequitable (we can’t randomly give some employees a benefit that we don’t give others), impractical (we can’t randomly assign a new corporate culture to half the company), or impossible (we can’t randomly assign personality traits). We are more often than not working with observational data, where people have already selected their own “treatments”.</p>
<p>To estimate a causal effect from such data, we need to try to emulate a randomized trial with statistics. To do this, we must rely on a set of critical, untestable assumptions. Conditional on these assumptions, we can recover unbiased estimates of causal effects. Let’s review these assumptions.</p>
<p>First, the <strong>Stable Unit Treatment Value Assumption (SUTVA)</strong> has two parts:</p>
<ul>
<li><p><strong>No interference:</strong> The potential outcomes for any individual are not affected by the treatment assignments of other individuals. In our management training example, this means that Jane’s team’s sales figure doesn’t change if her colleague David attends the training. This assumption is often violated in social settings. If Jane and David both attend, learn new techniques and subsequently collaborate, their combined effect might be larger than the sum of their individual effects (positive interference). Conversely, if both their teams are competing for the same pool of customers, David attending the training without Jane attending might negatively affect Jane’s outcome (negative interference).</p></li>
<li><p><strong>Consistency:</strong> The observed outcome for an individual who received the treatment <span class="math inline">\(T\)</span> is equal to their potential outcome under that specific treatment, <span class="math inline">\(Y(T)\)</span>. This sounds trivial, but it implies that the treatment is well-defined. “Management training” must mean the same thing for everyone. If part of Jane’s training is a follow up on how she passes on her learning to her team, but David is not given this follow up, then the treatment is not consistent between them. Their potential outcomes under the treatment are not comparable.</p></li>
</ul>
<p>Second, the <strong>Ignorability (or Exchangeability or Unconfoundedness)</strong> assumption is our attempt to statistically deal with confounding. Formally, it states that, conditional on a set of pre-treatment variables <span class="math inline">\(X\)</span>, the treatment assignment is independent of the potential outcomes. This is formally stated as<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<p><span class="math display">\[(Y(1), Y(0)) \perp T \mid X\]</span></p>
<p>That is, once we account for the variables in <span class="math inline">\(X\)</span>, the group that received the treatment and the group that did not are, on average, comparable, as if the treatment had been randomly assigned within each level of <span class="math inline">\(X\)</span>.</p>
<p>In our training example, we suspected that “motivation” might be a confounder. Managers’ motivation (<span class="math inline">\(X\)</span>) affects both their likelihood of taking the training (<span class="math inline">\(T\)</span>) and their team’s sales (<span class="math inline">\(Y\)</span>). Ignorability assumes that if we look only at a group of managers with the <em>same level of motivation</em>, then within that group, the decision to take the training was essentially random with respect to their potential team sales. By conditioning on (or controlling for) all possible common causes of the treatment and the outcome—the set of confounders <span class="math inline">\(X\)</span>—we hope to make the bias disappear. This is why it is sometimes called “conditional exchangeability”. We don’t believe the entire treatment and control groups are exchangeable, but we are willing to assume they are exchangeable with each level of <span class="math inline">\(X\)</span>.</p>
<p>Of course the challenge here is that we must identify and measure <em>all</em> the important confounders. If there is a confounder that we did not measure or include in our set <span class="math inline">\(X\)</span> (e.g., the managers’ level of prior experience), then this assumption will be violated, and our causal estimate will be biased due to unmeasured confounding. This is the biggest challenge of causal inference on observational people data. Many potential confounders are unknown, unmeasurable or both.</p>
<p>Third, the <strong>Positivity (or Overlap)</strong> assumption requires that for every combination of our confounding variables <span class="math inline">\(X\)</span> in our population, there is a non-zero probability of being both treated and untreated. This is formally stated as:</p>
<p><span class="math display">\[
\begin{aligned}
0 &lt; P(T=1 \mid X=x) &lt; 1 \\
0 &lt; P(T=0 \mid X=x) &lt; 1
\end{aligned}
\]</span></p>
<p>for all <span class="math inline">\(x \in X\)</span>. This means that there are no subgroups of people defined by our confounding variables who <em>always</em> or <em>never</em> receive the treatment. For example, if one of our confounding variables was ‘years experience’, and our management training was only ever offered to managers with more than 5 years of experience, then for managers with less than 5 years experience, <span class="math inline">\(P(T=1 \mid X) = 0\)</span>. We have no data on what would happen if a junior manager took the training, so we cannot estimate the effect for them. There is no “overlap” in the data for that subgroup.</p>
<p>If positivity is violated, we simply cannot estimate the ATT for some groups associated with our confounding variables, and we would have to rethink our approach to the analysis.</p>
</section>
<section id="the-boobytraps-of-causal-inference" class="level3" data-number="15.2.4">
<h3 data-number="15.2.4" class="anchored" data-anchor-id="the-boobytraps-of-causal-inference"><span class="header-section-number">15.2.4</span> The ‘boobytraps’ of causal inference</h3>
<p>Armed with Rubin’s causal model and the key assumptions above, we can now articulate the common types of problems we might encounter in attempting to infer causality between a treatment and an outcome. All of these “boobytraps” relate to how we handle other variables outside the treatment variable <span class="math inline">\(T\)</span> and the outcome variable <span class="math inline">\(Y\)</span> in different situations.</p>
<ul>
<li><p><strong>Confounding:</strong> As we have seen, this is a central problem. A third variable (or set of variables) <span class="math inline">\(X\)</span> is a common cause of both the treatment <span class="math inline">\(T\)</span> and the outcome <span class="math inline">\(Y\)</span>. The relates to the assumption of ignorability. To obtain an unbiased estimate of the ATT, we must identify and condition on all confounding variables. In our management training example, if we fail to account for the managers’ motivation levels, which affects both their likelihood of taking the training and their team’s sales, our estimate of the training’s causal effect will be biased.</p></li>
<li><p><strong>Selection Bias:</strong> While confounding is a form of selection bias, this term specifically refers to a situation where the sample is selected (or the analysis is conditioned) based on factors related to the outcome. This relates to the assumption of positivity. If certain types of individuals are systematically excluded from the analysis based on their factors related to the outcome, it can bias our estimates. For example, if we only analyze data from managers who had high sales, we might overestimate the training’s effectiveness because we are ignoring those who had low sales.</p></li>
<li><p><strong>Mediation:</strong> In understanding causal mechanisms, it is critical to consider if a causal effect is operating via some intermediate variables or <em>mediators</em>. This relates to the assumption of SUTVA. If we condition on a mediator variable that lies on the causal path from treatment to outcome, we can block part of the causal effect we are trying to estimate. For example, imagine if the training results in managers teaching new sales techniques to their teams, which then impacts sales. If we condition our analysis on the specific sales techniques used by the teams, we will underestimate the total causal effect of the training on sales.</p></li>
</ul>
<p>The RCM gives us a clear language to define the causal effects we want to estimate. The assumptions of SUTVA, Ignorability, and Positivity define the “rules of the game” for when we can legitimately estimate those effects from observational data without bias. The challenge, however, is that the crucial assumption of Ignorability depends on identifying the correct set of confounding variables <em>X</em>. How do we do that? Simply throwing every variable we have into a regression model is not the answer and, in fact, it usually makes things worse.</p>
</section>
</section>
<section id="the-structural-causal-model-scm" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="the-structural-causal-model-scm"><span class="header-section-number">15.3</span> The structural causal model (SCM)</h2>
<p>The RCM is powerful for formally defining causal effects, but it only takes us so far. It tells us we need to condition on all confounders, but it doesn’t tell us how to identify them. For this, we will need to incorporate our subject-matter knowledge and our theories about how the system we are researching actually works. We can express our causal theories using the structural causal model (SCM). Graphs are the cornerstone of the SCM. They are a visual language for expressing our assumptions about the causal relationships between variables. By representing our assumptions in a graph, we can use a clear set of rules to determine the statistical implications of those assumptions and to estimate causal effects.</p>
<section id="directed-acyclic-graphs-dags" class="level3" data-number="15.3.1">
<h3 data-number="15.3.1" class="anchored" data-anchor-id="directed-acyclic-graphs-dags"><span class="header-section-number">15.3.1</span> Directed Acyclic Graphs (DAGs)</h3>
<p>Like all graphs, DAGs consist of two simple components:</p>
<ul>
<li><p><strong>Nodes (or Vertices):</strong> These represent variables. They can be anything we can measure or imagine: a treatment (e.g., training), an outcome (e.g., sales), and any other variables that are believed to play a role in a problem (e.g., motivation).</p></li>
<li><p><strong>Edges (or Arrows):</strong> These are directed arrows that connect two nodes. An arrow drawn from node A to node B (A -&gt; B), means we are <em>assuming</em> that variable A has a direct causal influence on variable B. The arrow represents a hypothetical intervention: if we were to intervene and change the value of A, we would expect to see a change in the value of B. “Direct” here means not mediated by any other variable already in the graph.</p></li>
</ul>
<p>DAGs must be <em>acyclic</em>. This means there are no loops in the graph. You cannot start at a node, follow the direction of the arrows, and end up back at the same node. This makes sense in most cross-sectional research studies, where it’s assumed that causation flows in one direction at any single point in time.</p>
<p>Let’s look at the simple example of our sales manager training program. Let’s say we believe that attendance at the training program has a direct causal effect on the sales of the manager’s team. Let’s also say we believe that a manager’s pre-existing motivation has a direct causal effect on both their decision to sign up for the training and their team’s sales. The DAG for this causal theory is shown in <a href="#fig-dagsimple" class="quarto-xref">Figure&nbsp;<span>15.1</span></a>.</p>
<div id="fig-dagsimple" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dagsimple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dagsimple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.1: DAG representing the assumed causal relationships between motivation, training, and sales.
</figcaption>
</figure>
</div>
<p>This simple graph encodes several causal beliefs: 1. <code>Motivation</code> has a direct causal effect on <code>Training</code> (more motivated managers are more likely to sign up). 2. <code>Motivation</code> has a direct causal effect on <code>Sales</code> (more motivated managers lead their teams to higher sales figures). 3. <code>Training</code> has a direct causal effect on <code>Sales</code> (this is the effect we want to estimate). 4. There are no other common causes of any two variables in the graph. 5. <code>Sales</code> does not have a direct causal effect on <code>Training</code> (the outcome doesn’t affect the treatment).</p>
<p>This DAG is our causal model. It is not derived from the data; it is imposed upon it by our expert knowledge and beliefs. The DAG forces us to be transparent about our assumptions, which can then be analyzed, critiqued or improved.</p>
</section>
<section id="dag-paths-and-the-three-fundamental-structures" class="level3" data-number="15.3.2">
<h3 data-number="15.3.2" class="anchored" data-anchor-id="dag-paths-and-the-three-fundamental-structures"><span class="header-section-number">15.3.2</span> DAG paths and the three fundamental structures</h3>
<p>The reason DAGs are so useful is that they provide rules for how statistical associations flow between variables. An association between two variables, X and Y, exists if there is an open (or unblocked) path between them in the DAG. A direct causal effect is one source of association, but there are others. By understanding the three fundamental structures that can exist between variables in a DAG, we can create a system through which we can identify open non-causal paths. Each of these structures relate to the “boobytraps” we discussed earlier: mediation, confounding and selection bias. They can be seen in <a href="#fig-dagstructures" class="quarto-xref">Figure&nbsp;<span>15.2</span></a>.</p>
<div id="fig-dagstructures" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dagstructures-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dagstructures-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.2: The three fundamental structures in DAGs: Chain (Mediation), Fork (Confounding), and Collider (Selection Bias). In the chain, M is the mediator. In the fork, C is the common cause (confounder). In selection bias, D is the collider and E is a descendent collider.
</figcaption>
</figure>
</div>
<p>Referring to <a href="#fig-dagstructures" class="quarto-xref">Figure&nbsp;<span>15.2</span></a>:</p>
<ul>
<li><p>Mediation is represented by a ‘chain’ structure. This means A has a direct causal effect on M, and M has a direct causal effect on B. M is a mediator variable. In a chain, there is a clear causal path from A to B. Therefore, A and B will be statistically associated. But if we condition on the mediator M, we <em>block</em> the flow of association between A and B. For example, if we believe <code>Motivation -&gt; Job Satisfaction -&gt; Job Performance</code>, then if we try to estimate the causal effect of <code>Motivation</code> on <code>Job Performance</code> we should not include <code>Job Satisfaction</code> in our statistical model. If we do, we will have a biased estimate.</p></li>
<li><p>Confounding is represented by a ‘fork’ structure. This means C is a common cause of both A and B. In this fork, there is no causal path from A to B. However, because they share a common cause, information flows from C to A and from C to B, creating a spurious (non-causal) association between A and B. If we were to naively correlate A and B, we would find an association, not because A has a direct causal effect on B, but because C has a direct causal effect on both. The non-causal path from A to B is called a ‘backdoor’ path, because A has an edge going into it rather than coming out of it. To block this backdoor path, we must condition on the common cause, C. For example, if we believe <code>Training &lt;- Motivation -&gt; Sales</code>, then to estimate the causal effect of <code>Training</code> on <code>Sales</code>, we must include <code>Motivation</code> in our model. If we leave it out, we will have a biased estimate.</p></li>
<li><p>Selection bias is represented by a ‘collider’ structure. This structure means A and B are both independent causes of a third variable, D. The arrows “collide” at D. In a collider structure, if A and B are independent to begin with, there is no open path between them. The collider D <em>naturally blocks</em> the flow of association. However, if we condition on the collider D, we <em>open the path</em> and create a spurious association between A and B where none existed before. For example, if we believe <code>Knowledge -&gt; Being Hired &lt;- Interpersonal Skills</code>, then in the general population, <code>Knowledge</code> and <code>Interpersonal Skills</code> are uncorrelated. But if we look only at only those who were hired, then within that selected group, <code>Knowledge</code> and <code>Interpersonal Skills</code> can become negatively correlated. Conditioning on the common effect (the collider) induces an association. Moreover, if a variable is a descendant of a collider (i.e., it is on a chain emanating from the collider, such as our variable <code>E</code>), conditioning on that descendant also opens the path.</p></li>
</ul>
<p>This leaves us with three critical rules for how associations flow through a DAG:</p>
<ol type="1">
<li>Conditioning on the middle variable in a chain blocks the path.</li>
<li>Conditioning on the common cause in a fork blocks the path.</li>
<li>Conditioning on a collider (or a descendant of a collider) opens a path.</li>
</ol>
</section>
<section id="sec-backdoor" class="level3" data-number="15.3.3">
<h3 data-number="15.3.3" class="anchored" data-anchor-id="sec-backdoor"><span class="header-section-number">15.3.3</span> D-separation and the backdoor criterion</h3>
<p>Our three rules form the basis of a concept called <strong>d-separation</strong> (for “directional separation”). Two variables in a DAG, X and Y, are said to be d-separated if there is no open path between them. If they are d-separated, the causal structure represented by the DAG implies that they should be statistically independent. If they are not d-separated (they are “d-connected”), they should be statistically associated.</p>
<p>The most important application of these rules is in finding a set of variables to control for to estimate a causal effect. Let’s say we want to estimate the causal effect of a treatment, T, on an outcome, Y. That is, we are interested in the direct causal path from T to Y.</p>
<p>The statistical association we measure between T and Y in our data can be a mixture of the true causal effect and any spurious associations from non-causal paths. Our goal is to isolate the causal path. To do this, we need to block all the open non-causal paths between T and Y, without blocking the causal path itself. This means we need to identify and block any <strong>backdoor path</strong> which is open. A backdoor path is any path that starts with an arrow pointing <em>into</em> T. For example, in our motivation fork (<code>Training</code> &lt;- <code>Motivation</code> -&gt; <code>Sales</code>), the path from <code>Training</code> to <code>Motivation</code> to <code>Sales</code> is a backdoor path. It creates a spurious association that we must block.</p>
<p>This leads us to the <strong>backdoor criterion</strong>, a powerful graphical test for choosing a sufficient set of control variables (an “adjustment set”) for testing a causal effect. Under the backdoor criterion, a set of variables Z is a sufficient adjustment set for estimating the causal effect of T on Y if two conditions are met:</p>
<ol type="1">
<li>No variable in Z is a descendant of T (we don’t control for mediators or other variables caused by the treatment).</li>
<li>The variables in Z block every backdoor path between T and Y.</li>
</ol>
<p>If we can find a set of variables Z that satisfies the backdoor criterion, then we can estimate the causal effect of T on Y by conditioning on Z. In practice, this means including Z along with T as input variables in a regression model.</p>
<p>Let’s look at a specific example in order to see this criterion in action.</p>
</section>
<section id="example-of-applying-the-backdoor-criterion" class="level3" data-number="15.3.4">
<h3 data-number="15.3.4" class="anchored" data-anchor-id="example-of-applying-the-backdoor-criterion"><span class="header-section-number">15.3.4</span> Example of applying the backdoor criterion</h3>
<p>A company runs a selection process for hiring new graduates. The process involves a test, a one-on-one interview and a presentation to a panel. We have scoring data on the all of these, as well as data on the graduates’ academic performance (GPA). We are interested in determining the causal effect of the test score (our treatment) on the likelihood of being hired (our outcome). We have the following causal model in mind:</p>
<ul>
<li>The test, the interview and the presentation all have direct causal effects on the hiring decision.</li>
<li>The presentation has a direct causal effect on the interview (because the interview is conducted by a member of the presentation panel)</li>
<li>The academic ability of the graduate has a direct causal effect on their test, interview and presentation.</li>
<li>There are no other direct causal effects.</li>
</ul>
<p>The DAG for this causal model is shown in <a href="#fig-dagcomplex" class="quarto-xref">Figure&nbsp;<span>15.3</span></a>.</p>
<div id="fig-dagcomplex" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dagcomplex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dagcomplex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.3: DAG representing beliefs about causal relationships between a hiring decision, test, interview, presentation and GPA.
</figcaption>
</figure>
</div>
<p>Let’s identify all the paths between <code>Test</code> and <code>Hire</code> and use the backdoor criterion find a sufficient adjustment set using the backdoor criterion.</p>
<ul>
<li><strong>Path 1 (The Causal Path):</strong> <code>Test -&gt; Hire</code>. We want to keep this path open. It is causal because it flows in the direction of the arrows from treatment variable to outcome variable.</li>
<li><strong>Path 2 (A Backdoor Path):</strong> <code>Test &lt;- GPA -&gt; Int -&gt; Hire</code>. This is a classic confounding path through <code>GPA</code>. It’s a fork, with a chain from <code>GPA</code> to <code>Hire</code>. To block it, we have two options. We can condition on the common cause <code>GPA</code>, and then we do not need to condition on <code>Int</code> because by conditioning on <code>GPA</code> we have already blocked the backdoor path. Alternatively, we can condition on <code>Int</code> to black the path through the chain.</li>
<li><strong>Path 3 (Another Backdoor Path):</strong> `<code>Test &lt;- GPA -&gt; Pres -&gt; Hire</code>. This is another backdoor path through <code>GPA</code> and <code>Pres</code>. It’s another fork followed by a chain. Conditioning on <code>GPA</code> will also block this path, or alternatively so will conditioning on <code>Pres</code>.</li>
<li><strong>Path 4 (Another Backdoor Path):</strong> <code>Test &lt;- GPA -&gt; Pres -&gt; Int -&gt; Hire</code>. This is yet another backdoor path through <code>GPA</code>, <code>Pres</code> and <code>Int</code>. It’s another fork followed by a longer chain. Conditioning on <code>GPA</code> will also block this path, as will conditioning on <code>Pres</code> or <code>Int</code>.</li>
</ul>
<p>This provides us with two possible adjustment sets for determining the causal effect of <code>Test</code> on <code>Hire</code>:</p>
<ol type="1">
<li><code>{GPA}</code>: By conditioning on <code>GPA</code> alone, we block all backdoor paths (Paths 2, 3 and 4) while keeping the causal path (Path 1) open.</li>
<li><code>{Int, Pres}</code>: By conditioning on both <code>Int</code> and <code>Pres</code>, we also block all backdoor paths while keeping the causal path open.</li>
</ol>
<p>This means that if we want to run a regression model to determine the causal effect of <code>Test</code> on <code>Hire</code>, we can either include <code>GPA</code> as a control variable, or we can include both <code>Int</code> and <code>Pres</code> as control variables. Either approach will give us an unbiased estimate of the causal effect of <code>Test</code> on <code>Hire</code>, conditional on our DAG.</p>
<p>This example illustrates the power of DAGs. Without drawing the graph and applying the backdoor criterion, a researcher might be tempted to control for everything they measured. The DAG shows that this “kitchen sink” approach to regression is not just unnecessary, but it can lead to major errors in inferring causal effects. DAGs provides a principled, theory-driven way to construct regression models.</p>
</section>
</section>
<section id="causal-inference-in-r" class="level2" data-number="15.4">
<h2 data-number="15.4" class="anchored" data-anchor-id="causal-inference-in-r"><span class="header-section-number">15.4</span> Causal inference in R</h2>
<p>In R, the <code>dagitty</code> package allows you to specify a DAG using a simple text-based syntax. Once specified, you can query the DAG to find parents, children, ancestors, descendants, identify instrumental variables, and, most importantly, find adjustment sets using the backdoor criterion. It can also list the “testable implications” of your DAG-—-that is, the conditional independencies that should hold true in your data if your causal model is correct, which you can verify.</p>
<p>The <code>ggdag</code> package is built on top of <code>ggplot2</code> and works seamlessly with <code>dagitty</code> objects. It provides an easy and highly customizable way to create visualizations of your DAGs. It can automatically highlight paths, adjustment sets, and other features, making it a very helpful tool for both analysis and communication.</p>
<p>Let’s use our selection process example from <a href="#sec-backdoor" class="quarto-xref"><span>Section 15.3.3</span></a> as a walkthrough example to illustrate how to do causal inference in R using the <code>dagitty</code> and <code>ggdag</code> packages.</p>
<section id="walkthrough-example" class="level3" data-number="15.4.1">
<h3 data-number="15.4.1" class="anchored" data-anchor-id="walkthrough-example"><span class="header-section-number">15.4.1</span> Walkthrough example</h3>
<p>The <code>selection</code> data set contains data related to the hiring process for 70 candidates in a graduate hiring program. The data contains the following variables:</p>
<ul>
<li><code>Hire</code>: A binary variable indicating whether the candidate was hired (1) or not (0).</li>
<li><code>Test</code>: The candidate’s score out of a maximum of 15 on a written test.</li>
<li><code>Int</code>: The candidate’s rating from a one-on-one interview, on an integer scale from 1 (Low) to 5 (High).</li>
<li><code>Pres</code>: The candidate’s average rating from a presentation to a panel, on an scale from 1 (Low) to 5 (High).</li>
<li><code>GPA</code>: The candidate’s undergraduate Grade Point Average (GPA), on a scale from 1.0 to 5.0.</li>
</ul>
<p>Let’s take a quick look at the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the selection data set</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://peopleanalytics-regression-book.org/data/selection.csv"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>selection <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(url)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># view the first few rows of the data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(selection)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  GPA Test Pres Int Hire
1 3.3   10  3.6   3    1
2 2.6    8  3.9   2    1
3 3.0    9  3.1   4    1
4 3.6    9  2.5   4    1
5 3.1    9  3.6   3    1
6 3.5   13  2.8   3    0</code></pre>
</div>
</div>
<p>Before we define a causal model to work with, let’s look at what a ‘naive’ analysis would look like. We can run a simple Bayesian logistic regression predicting <code>Hire</code> from <code>Test</code> alone.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># run simple Bayesian logistic regression</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>naive_model <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Hire <span class="sc">~</span> Test,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> selection,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">bernoulli</span>(),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_pars =</span> <span class="fu">save_pars</span>(<span class="st">'all'</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now take a look at our posterior coefficients for <code>Test</code>, as in <a href="#fig-naiveposterior" class="quarto-xref">Figure&nbsp;<span>15.4</span></a>.</p>
<div id="fig-naiveposterior" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-naiveposterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># view posterior for Test coefficient</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(naive_model),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="st">"b_Test"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> <span class="fl">0.95</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-naiveposterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.4: Posterior distribution of the odds ratio for <code>Test</code> from a naive Bayesian logistic regression predicting <code>Hire</code> from <code>Test</code> alone.
</figcaption>
</figure>
</div>
<p>This naive model suggests a high probability (86.9%) that the test has a positive effect on the log odds of being hired, giving us a degree of confidence that the test is providing a meaningful contribution to the hiring decision. However, we have no idea how much of this effect is a direct causal effect. There may be confounding variables biasing this estimate. To determine what variables to control for, we need to define our causal model using a DAG.</p>
<p>We have a hypothesized causal model for how these variables relate to each other, as shown earlier in <a href="#fig-dagcomplex" class="quarto-xref">Figure&nbsp;<span>15.3</span></a>. We want to estimate the causal effect of <code>Test</code> on <code>Hire</code>. According to our earlier manual backdoor analysis, we should find that we are able to do this by controlling for either <code>GPA</code> alone, or for both <code>Int</code> and <code>Pres</code>.</p>
</section>
<section id="specifying-and-visualizing-the-dag" class="level3" data-number="15.4.2">
<h3 data-number="15.4.2" class="anchored" data-anchor-id="specifying-and-visualizing-the-dag"><span class="header-section-number">15.4.2</span> Specifying and visualizing the DAG</h3>
<p>The syntax for defining a DAG using <code>dagitty</code> is straightforward. We define the nodes and edges in a string format. The treatment (exposure) and outcome variables can be specified using special tags.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the selection DAG</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>selection_dag_string <span class="ot">&lt;-</span> <span class="st">"dag {</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="st">  GPA</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="st">  Hire [Outcone]</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="st">  Pres</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="st">  Int</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="st">  Test [Exposure]</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="st">  Hire &lt;- Pres</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="st">  Hire &lt;- Int</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="st">  Hire &lt;- Test</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="st">  Int &lt;- Pres</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="st">  Pres &lt;- GPA</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="st">  Int &lt;- GPA</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="st">  Test &lt;- GPA</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="st">}"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, we can use the <code>dagify</code> function from <code>ggdag</code> to create the same DAG string using a formula syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define using dagify</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>(selection_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  Hire <span class="sc">~</span> Pres <span class="sc">+</span> Int <span class="sc">+</span> Test,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  Int <span class="sc">~</span> Pres <span class="sc">+</span> GPA,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  Pres <span class="sc">~</span> GPA,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  Test <span class="sc">~</span> GPA,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="at">Hire =</span> <span class="st">"Hire"</span>, <span class="at">Pres =</span> <span class="st">"Pres"</span>, <span class="at">Int =</span> <span class="st">"Int"</span>, <span class="at">Test =</span> <span class="st">"Test"</span>, <span class="at">GPA =</span> <span class="st">"GPA"</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"Test"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Hire"</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dag {
GPA
Hire [outcome]
Int
Pres
Test [exposure]
GPA -&gt; Int
GPA -&gt; Pres
GPA -&gt; Test
Int -&gt; Hire
Pres -&gt; Hire
Pres -&gt; Int
Test -&gt; Hire
}</code></pre>
</div>
</div>
<p>The <code>ggdag</code> package makes plotting this DAG very easy, as in <a href="#fig-dagplot" class="quarto-xref">Figure&nbsp;<span>15.5</span></a>.</p>
<div id="fig-dagplot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dagplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(selection_dag) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dagplot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.5: DAG representing beliefs about causal relationships between a Hiring Decision, Test Score, Interview Score, Presentation Score, and GPA.
</figcaption>
</figure>
</div>
<p>To control the positioning of the nodes, we can specify relative coordinates in the DAG string or use the <code>coords</code> argument in <code>dagify</code>. For example, to replicate the positioning as in <a href="#fig-dagcomplex" class="quarto-xref">Figure&nbsp;<span>15.3</span></a>, we can do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(selection_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  Hire <span class="sc">~</span> Pres <span class="sc">+</span> Int <span class="sc">+</span> Test,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  Int <span class="sc">~</span> Pres <span class="sc">+</span> GPA,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  Pres <span class="sc">~</span> GPA,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  Test <span class="sc">~</span> GPA,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="at">Hire =</span> <span class="st">"Hire"</span>, <span class="at">Pres =</span> <span class="st">"Pres"</span>, <span class="at">Int =</span> <span class="st">"Int"</span>, <span class="at">Test =</span> <span class="st">"Test"</span>, <span class="at">GPA =</span> <span class="st">"GPA"</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"Test"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Hire"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="at">Hire =</span> <span class="dv">0</span>, <span class="at">Pres =</span> <span class="dv">2</span>, <span class="at">Int =</span> <span class="dv">1</span>, <span class="at">Test =</span> <span class="dv">0</span>, <span class="at">GPA =</span> <span class="dv">2</span>),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Hire =</span> <span class="dv">0</span>, <span class="at">Pres =</span> <span class="dv">0</span>, <span class="at">Int =</span> <span class="dv">1</span>, <span class="at">Test =</span> <span class="dv">2</span>, <span class="at">GPA =</span> <span class="dv">2</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dag {
GPA [pos="2.000,2.000"]
Hire [outcome,pos="0.000,0.000"]
Int [pos="1.000,1.000"]
Pres [pos="2.000,0.000"]
Test [exposure,pos="0.000,2.000"]
GPA -&gt; Int
GPA -&gt; Pres
GPA -&gt; Test
Int -&gt; Hire
Pres -&gt; Hire
Pres -&gt; Int
Test -&gt; Hire
}</code></pre>
</div>
</div>
<p>We can convert our <code>dagitty</code> object into a tidy data format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(selection_dag_tidy <span class="ot">&lt;-</span> ggdag<span class="sc">::</span><span class="fu">tidy_dagitty</span>(selection_dag))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A DAG with 5 nodes and 7 edges
#
# Exposure: Test
# Outcome: Hire
#
# A tibble: 8 × 9
  name      x     y direction to     xend  yend circular label
  &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;fct&gt;     &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;lgl&gt;    &lt;chr&gt;
1 GPA       2     2 -&gt;        Int       1     1 FALSE    GPA  
2 GPA       2     2 -&gt;        Pres      2     0 FALSE    GPA  
3 GPA       2     2 -&gt;        Test      0     2 FALSE    GPA  
4 Hire      0     0 &lt;NA&gt;      &lt;NA&gt;     NA    NA FALSE    Hire 
5 Int       1     1 -&gt;        Hire      0     0 FALSE    Int  
6 Pres      2     0 -&gt;        Hire      0     0 FALSE    Pres 
7 Pres      2     0 -&gt;        Int       1     1 FALSE    Pres 
8 Test      0     2 -&gt;        Hire      0     0 FALSE    Test </code></pre>
</div>
</div>
<p>This can make it easier to add customizations to our graph visualization using <code>ggplot2</code>. For example we can color code the nodes based on their roles (exposure, outcome, confounder) as in <a href="#fig-dagcustom" class="quarto-xref">Figure&nbsp;<span>15.6</span></a>.</p>
<div id="fig-dagcustom" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dagcustom-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add a role column to the tidy dag</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>selection_dag_tidy <span class="ot">&lt;-</span> selection_dag_tidy <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">role =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      name <span class="sc">==</span> <span class="st">"Test"</span> <span class="sc">~</span> <span class="st">"Exposure"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      name <span class="sc">==</span> <span class="st">"Hire"</span> <span class="sc">~</span> <span class="st">"Outcome"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># plot with custom colors in ggdag</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(selection_dag_tidy, <span class="at">stylized =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_node</span>(<span class="fu">aes</span>(<span class="at">color =</span> role), <span class="at">size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dagcustom-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.6: DAG with custom coloring of nodes based on their roles (exposure, outcome, other).
</figcaption>
</figure>
</div>
</section>
<section id="deriving-information-from-the-dag" class="level3" data-number="15.4.3">
<h3 data-number="15.4.3" class="anchored" data-anchor-id="deriving-information-from-the-dag"><span class="header-section-number">15.4.3</span> Deriving information from the DAG</h3>
<p>We can ask <code>dagitty</code> what to find our adjustment sets based on our exposure and outcome variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the adjustment set for the effect of Test on Hire</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adjustmentSets</span>(selection_dag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{ Int, Pres }
{ GPA }</code></pre>
</div>
</div>
<p>This confirms the adjustments sets which we derived manually earlier in <a href="#sec-backdoor" class="quarto-xref"><span>Section 15.3.3</span></a>. We can also view the adjustment sets using <code>ggdag</code>, as in <a href="#fig-dagadjust" class="quarto-xref">Figure&nbsp;<span>15.7</span></a>.</p>
<div id="fig-dagadjust" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dagadjust-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag_adjustment_set</span>(selection_dag) <span class="sc">+</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dagadjust-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.7: Adjustment sets for estimating the causal effect of <code>Test</code> on <code>Hire</code>.
</figcaption>
</figure>
</div>
<p>We can also ask <code>dagitty</code> to show us the paths between the exposure and outcome variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paths</span>(selection_dag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$paths
[1] "Test -&gt; Hire"                       "Test &lt;- GPA -&gt; Int -&gt; Hire"        
[3] "Test &lt;- GPA -&gt; Int &lt;- Pres -&gt; Hire" "Test &lt;- GPA -&gt; Pres -&gt; Hire"       
[5] "Test &lt;- GPA -&gt; Pres -&gt; Int -&gt; Hire"

$open
[1]  TRUE  TRUE FALSE  TRUE  TRUE</code></pre>
</div>
</div>
<p>We can see that 5 paths have been identified, four of which are open paths. One of these is the direct causal path and the other three are backdoor paths. These open paths can be visualized using <code>ggdag</code>, as in <a href="#fig-dagpaths" class="quarto-xref">Figure&nbsp;<span>15.8</span></a>.</p>
<div id="fig-dagpaths" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dagpaths-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag_paths_fan</span>(selection_dag) <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dagpaths-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.8: Open paths between <code>Test</code> and <code>Hire</code> in the DAG.
</figcaption>
</figure>
</div>
<p>Another powerful feature of <code>dagitty</code> is its ability to list the <em>testable implications</em> of our hypothesized causal model. If our model is true, it often implies that certain variables should be independent of each other (d-separated), conditional on other variables. These are the conditional independencies predicted by the d-separation rules, and we can verify if they are supported by the data. If they are not, it suggests our DAG is incorrect and needs to be revised.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">impliedConditionalIndependencies</span>(selection_dag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GPA _||_ Hire | Int, Pres, Test
Int _||_ Test | GPA
Pres _||_ Test | GPA</code></pre>
</div>
</div>
<p>To understand the output, we can interpret each line as a conditional independence statement. For example, the first line means that <code>GPA</code> is independent of <code>Hire</code> when conditioned on <code>Int</code>, <code>Pres</code> and <code>Test</code>. This makes sense because the three conditioned variables are mediators between <code>GPA</code> and <code>Hire</code> on chain paths, and we know that when we condition on a mediator we block the path, this making <code>GPA</code> and <code>Hire</code> d-separated.</p>
</section>
<section id="using-dags-to-guide-regression-analyses" class="level3" data-number="15.4.4">
<h3 data-number="15.4.4" class="anchored" data-anchor-id="using-dags-to-guide-regression-analyses"><span class="header-section-number">15.4.4</span> Using DAGs to guide regression analyses</h3>
<p>Now that we have identified our adjustment sets and implied conditional independencies, we can use them to guide our regression analyses in determining the causal effect of the test performance on the hiring decision. Although we can use DAGs alongside classical (frequentist) regression models, it is more common nowadays to use them with Bayesian regression models. Bayesian models provide a more intuitive framework for causal inference, allowing us to directly estimate the posterior distribution of causal effects and incorporate prior knowledge into our analyses.</p>
<p>First, we can test our conditional independencies implied by our DAG using regression models. We can test the first conditional independence statement: <code>GPA</code> is independent of <code>Hire</code> when conditioned on <code>Int</code>, <code>Pres</code> and <code>Test</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a Bayesian binomial regression model</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>model_ci <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Hire <span class="sc">~</span> GPA <span class="sc">+</span> Int <span class="sc">+</span> Pres <span class="sc">+</span> Test,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> selection,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">bernoulli</span>(),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_pars =</span> <span class="fu">save_pars</span>(<span class="st">'all'</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now examine the posterior distribution of the GPA coefficient.</p>
<div id="fig-selection-ci" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-selection-ci-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the posterior coefficients</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(model_ci),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b_GPA"</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> <span class="fl">0.66</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-selection-ci-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.9: Posterior distribution of the GPA coefficient from the Bayesian regression model testing the conditional independence implied by the DAG.
</figcaption>
</figure>
</div>
<p><a href="#fig-selection-ci" class="quarto-xref">Figure&nbsp;<span>15.9</span></a> shows the posterior distribution of the GPA coefficient, with a 66% credible interval shaded, and even this narrow credible interval contains zero. Based on this, we can determine a level of comfort that our DAG supported by our observed data.</p>
<p>Assuming our other conditional dependencies are supported by the data (which should be tested), we can now estimate the causal effect of <code>Test</code> on <code>Hire</code> using any of the two adjustment sets we identified earlier. In this case, we will control for <code>GPA</code> alone.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a Bayesian binomial regression model to estimate the causal effect of Test on Hire</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>model_causal <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Hire <span class="sc">~</span> Test <span class="sc">+</span> GPA,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> selection,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">bernoulli</span>(),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_pars =</span> <span class="fu">save_pars</span>(<span class="st">'all'</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can visualize our causal effect estimate for <code>Test</code>, as in <a href="#fig-selection-causal" class="quarto-xref">Figure&nbsp;<span>15.10</span></a>.</p>
<div id="fig-selection-causal" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-selection-causal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the posterior coefficient for Test as odds ratio</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(model_causal),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b_Test"</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> <span class="fl">0.95</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_inference_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-selection-causal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.10: Posterior distribution of the causal effect of <code>Test</code> on <code>Hire</code>
</figcaption>
</figure>
</div>
<p>We can also view the 95% credible interval for the causal effect of <code>Test</code> on <code>Hire</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get 95% credible interval for the causal effect of Test on Hire</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>(ci <span class="ot">&lt;-</span> <span class="fu">posterior_summary</span>(<span class="fu">as.matrix</span>(model_causal), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))[<span class="st">"b_Test"</span>, <span class="fu">c</span>(<span class="st">"Q2.5"</span>, <span class="st">"Q97.5"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Q2.5      Q97.5 
-0.3010211  0.4431564 </code></pre>
</div>
</div>
<p>We can directly determine the probability that the effect of the test score is positive by calculating the proportion of posterior samples where the coefficient for <code>Test</code> is greater than zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the probability that the effect of Test is positive</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>posterior_samples_causal <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(model_causal)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>(prob_positive <span class="ot">&lt;-</span> <span class="fu">mean</span>(posterior_samples_causal[,<span class="st">"b_Test"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6265</code></pre>
</div>
</div>
<p>This indicates that there is a 62.6% probability that the test score has a positive causal effect on the log odds of being hired. This is a big difference from our earlier naive estimation, and gives us much lower confidence that the test is making a meaningful contribution to the hiring decision. Controlling for our confounder <code>GPA</code> has had a major impact on our estimate.</p>
</section>
</section>
<section id="learning-exercises" class="level2" data-number="15.5">
<h2 data-number="15.5" class="anchored" data-anchor-id="learning-exercises"><span class="header-section-number">15.5</span> Learning exercises</h2>
<section id="discussion-questions" class="level3" data-number="15.5.1">
<h3 data-number="15.5.1" class="anchored" data-anchor-id="discussion-questions"><span class="header-section-number">15.5.1</span> Discussion questions</h3>
<ol type="1">
<li><p>What are the different types of treatment effects defined in the Rubin causal model? How are they defined mathematically?</p></li>
<li><p>What is ‘bias’ in the context of the Potential Outcomes framework? Give a common reason why the naive estimate of a treatment effect might be biased.</p></li>
<li><p>Outline the three key assumptions (SUTVA, Ignorability, Positivity) required for unbiased causal inference on observational data.</p></li>
<li><p>Explain the three fundamental structures in Directed Acyclic Graphs (DAGs): chain, fork, and collider. How do these structures relate to mediation, confounding, and selection bias?</p></li>
<li><p>What is the difference between a causal path and a backdoor path in a Directed Acyclic Graph (DAG)? Why is it important to distinguish between the two when estimating causal effects?</p></li>
<li><p>What does it mean for two variables to be d-separated in a DAG? How does d-separation relate to statistical independence?</p></li>
<li><p>What is the Backdoor Criterion, and how does it help in identifying a sufficient adjustment set for estimating causal effects?</p></li>
<li><p>How can DAGs be used to guide regression analyses for causal inference? What are the advantages of using DAGs in this context?</p></li>
<li><p>Why is it important to test the conditional independencies implied by a DAG before using it to estimate a causal effect?</p></li>
<li><p>Consider a multivariable problem that you have dealt with in your study or work? How might you apply causal inference techniques to this problem?</p></li>
</ol>
</section>
<section id="data-exercises" class="level3" data-number="15.5.2">
<h3 data-number="15.5.2" class="anchored" data-anchor-id="data-exercises"><span class="header-section-number">15.5.2</span> Data exercises</h3>
<p>For our data exercises in this chapter, we will return to the <code>sociological_data</code> dataset in <a href="linear_regression.html#sec-lin-reg-ols-exercises" class="quarto-xref"><span>Section 4.8</span></a>. Take a random sample of about 20% of the observations and assume that this is the only data you have available. For this exercise, our aim will be to determine the causal effect of <code>education_months</code> on <code>annual_income_ppp</code>. We will assume that we have the following causal model in mind:</p>
<ul>
<li><code>education_months</code>, <code>average_wk_hrs</code>, <code>job_type</code> and <code>gender</code> all have direct causal effects on <code>annual_income_ppp</code>.</li>
<li><code>education_months</code>, <code>languages</code>, <code>gender</code> and <code>region</code> has a direct causal effect on <code>job_type</code></li>
<li><code>gender</code>, <code>region</code> and <code>family_size</code> have direct causal effects on <code>education_months</code></li>
<li><code>work_distance</code> has a direct causal effect on <code>average_wk_hrs</code></li>
<li>There are no other causal effects between variables.</li>
</ul>
<ol type="1">
<li><p>Using a naive Bayesian regression model, estimate the effect of <code>education_months</code> on <code>annual_income_ppp</code> without controlling for any other variables. Visualize the posterior distribution of the effect estimate and interpret the results.</p></li>
<li><p>Using the <code>dagitty</code> or <code>ggdag</code> package in R, specify the DAG representing the causal model described above.</p></li>
<li><p>Experiment with adjusting your visualization. Try changing the layout, colors, and sizes to improve clarity.</p></li>
<li><p>Identify all the paths between <code>education_months</code> and <code>annual_income_ppp</code>. Classify each path as either a causal path or a backdoor path.</p></li>
<li><p>Using the backdoor criterion, determine a sufficient adjustment set for estimating the causal effect of <code>education_months</code> on <code>annual_income_ppp</code>. Try to do this manually first, then verify your answer using the appropriate function in <code>dagitty</code> or <code>ggdag</code>.</p></li>
<li><p>List the conditional independencies implied by your DAG. Using regression models, test at least two of these conditional independencies using the <code>sociological_data</code> dataset.</p></li>
<li><p>Finally, estimate the causal effect of <code>education_months</code> on <code>annual_income_ppp</code> using a Bayesian regression model that controls for the variables in your adjustment set.</p></li>
<li><p>Visualize the posterior distribution of the causal effect estimate and interpret the results. Give the 95% credible interval for the causal effect estimate. How has your estimate changed compared to the naive model in Question 1?</p></li>
<li><p>Experiment with adjusting the causal model above. Suggest two alternative models that might also be plausible. If you wish, use checks of the conditional independencies of the original model to guide your modifications.</p></li>
<li><p>For each alternative model, repeat steps 1-7 and compare the causal effect estimates you obtain. How sensitive are your results to changes in the causal model?</p></li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-brumback2022" class="csl-entry" role="listitem">
Brumback, Babette A. 2022. <em>Fundamentals of Causal Inference: With r</em>.
</div>
<div id="ref-holland1986" class="csl-entry" role="listitem">
Holland, Paul W. 1986. <span>“Statistics and Causal Inference.”</span> <em>Journal of the American Statistical Association</em>.
</div>
<div id="ref-imbens2015" class="csl-entry" role="listitem">
Imbens, Guido W., and Donald B. Rubin. 2015. <em>Causal Inference for Statistics, Social, and Biomedical Sciences: An Introduction</em>.
</div>
<div id="ref-mcelreath" class="csl-entry" role="listitem">
McElreath, Richard. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in <span>R</span> and <span>Stan</span></em>.
</div>
<div id="ref-pearl2000" class="csl-entry" role="listitem">
Pearl, Judea. 2000. <em>Causality: Models, Reasoning, and Inference</em>.
</div>
<div id="ref-pearl2016" class="csl-entry" role="listitem">
Pearl, Judea, Madelyn Glymour, and Nicholas P. Jewell. 2016. <em>Causal Inference in Statistics: A Primer</em>.
</div>
<div id="ref-pearl2019" class="csl-entry" role="listitem">
Pearl, Judea, and Dana Mackenzie. 2019. <em>The Book of Why: The New Science of Cause and Effect</em>.
</div>
<div id="ref-rubin1974" class="csl-entry" role="listitem">
Rubin, Donald B. 1974. <span>“Estimating Causal Effects of Treatments in Randomized and Nonrandomized Studies.”</span> <em>Journal of Educational Psychology</em>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>Another source of bias is when treatment effects differ between individuals. This is known as the Heterogeneous Treatment Effect (HTE) bias. In our causal models, we make the assumption that there is no HTE bias and that Y(1) - Y(0) is the same across all individuals.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The symbol <span class="math inline">\(\perp\)</span> is used in mathematics to mean ‘is independent of’.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/peopleanalytics-regression-book-2nd-edition\.org\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./other_bayesian_regression.html" class="pagination-link" aria-label="Fitting Other Regression Models Using Bayesian Inference">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Fitting Other Regression Models Using Bayesian Inference</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./further.html" class="pagination-link" aria-label="Further Exercises for Practice">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Further Exercises for Practice</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/keithmcnulty/regression-handbook-2nd-edition/edit/main/causal_inference.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/keithmcnulty/regression-handbook-2nd-edition/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>